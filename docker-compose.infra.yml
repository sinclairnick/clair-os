# Development Docker Compose - Infrastructure Only
# Usage: docker-compose -f docker-compose.infra.yml up -d
#
# This runs only the infrastructure services (database, OpenFGA).
# Run your app services locally for the best DX:
#   pnpm run dev:api   # API with hot reload on :3001
#   pnpm run dev:app   # Frontend with HMR on :5173
#
# Services:
# - PostgreSQL: localhost:5432 (user: clairios, pass: clairios_dev)
# - OpenFGA API: localhost:8080
# - OpenFGA Playground: http://localhost:3002

services:
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: clairios
      POSTGRES_PASSWORD: ${DB_PASSWORD:-clairios_dev}
      POSTGRES_DB: clairios
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U clairios"]
      interval: 5s
      timeout: 5s
      retries: 5

  # OpenFGA migration - runs once to set up tables
  openfga-migrate:
    image: openfga/openfga:latest
    command: migrate
    environment:
      OPENFGA_DATASTORE_ENGINE: postgres
      OPENFGA_DATASTORE_URI: postgres://clairios:${DB_PASSWORD:-clairios_dev}@db:5432/clairios?sslmode=disable
    depends_on:
      db:
        condition: service_healthy

  # OpenFGA authorization service
  openfga:
    image: openfga/openfga:latest
    restart: unless-stopped
    command: run
    environment:
      OPENFGA_DATASTORE_ENGINE: postgres
      OPENFGA_DATASTORE_URI: postgres://clairios:${DB_PASSWORD:-clairios_dev}@db:5432/clairios?sslmode=disable
      OPENFGA_LOG_FORMAT: json
    ports:
      - "8080:8080"   # HTTP API
      - "8081:8081"   # gRPC API
      - "3002:3000"   # Playground
    depends_on:
      openfga-migrate:
        condition: service_completed_successfully

volumes:
  postgres_data:
